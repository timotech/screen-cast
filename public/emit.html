<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- <script src="http://code.jquery.com/jquery-1.11.2.min.js"></script> -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/qs/6.9.3/qs.min.js"
      integrity="sha256-lSPkSu/D04IeqWOhTgTf5tLzNFEc37oNE9ysGS9PdK4="
      crossorigin="anonymous"
    ></script>
    <script type="text/javascript" src="/socket.io/socket.io.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css"
      integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk="
      crossorigin="anonymous"
    />
    <link href="emit.css" rel="stylesheet" />
  </head>
  <body>
    <div class="outerContainer">
      <div class="videoContainer">
        <video
          src=""
          id="video"
          style="width: 700px; height: 350px;"
          autoplay="true"
        ></video>
        <a href="./screening/screen.html" class="btn" target="_blank"
          >Start Desktop Screening</a
        >
      </div>
      <div class="container">
        <div class="chat-container">
          <header class="chat-header">
            <h1><i class="fas fa-smile"></i> Class Chat</h1>
            <a href="index.html" class="btn">Leave Class</a>
          </header>
          <main class="chat-main">
            <div class="chat-sidebar">
              <h3><i class="fas fa-comments"></i> Class Name:</h3>
              <h2 id="room-name"></h2>
              <h3><i class="fas fa-users"></i> Students</h3>
              <ul id="users"></ul>
            </div>
            <div class="chat-messages"></div>
          </main>
          <div class="chat-form-container">
            <form id="chat-form">
              <input
                id="msg"
                type="text"
                placeholder="Enter Message"
                required
                autocomplete="off"
              />
              <button class="btn">
                <i class="fas fa-paper-plane"></i> Send
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <canvas style="display: none;" id="preview"></canvas>
    <div id="logger"></div>
  </body>
  <script type="text/javascript">
    const chatForm = document.getElementById("chat-form");
    const chatMessages = document.querySelector(".chat-messages");
    const roomName = document.getElementById("room-name");
    const userList = document.getElementById("users");

    // Get username and room from URL
    const { username, room } = Qs.parse(location.search, {
      ignoreQueryPrefix: true,
    });

    var canvas = document.getElementById("preview");
    var context = canvas.getContext("2d");

    canvas.width = 700;
    canvas.height = 350;

    context.width = canvas.width;
    context.height = canvas.height;

    var video = document.getElementById("video");

    const socket = io();

    function logger(msg) {
      $("#logger").text(msg);
    }

    function loadCamera(stream) {
      try {
        video.srcObject = stream;
      } catch (error) {
        video.src = URL.createObjectURL(stream);
      }
      logger("Camera connected");
    }

    function loadFail() {
      logger("Camera not connected");
    }

    function viewVideo(video, context) {
      context.drawImage(video, 0, 0, context.width, context.height);
      socket.emit("stream", canvas.toDataURL("image/webp"));
    }

    $(function () {
      navigator.getUserMedia =
        navigator.getUserMedia ||
        navigator.webkitGetUserMedia ||
        navigator.mozGetUserMedia ||
        navigator.msgGetUserMedia;

      if (navigator.getUserMedia) {
        navigator.getUserMedia(
          { video: true, audio: true },
          loadCamera,
          loadFail
        );
      }

      setInterval(function () {
        viewVideo(video, context);
      }, 3);
    });

    //Chat Section

    // Join chatroom
    socket.emit("joinRoom", { username, room });

    // Get room and users
    socket.on("roomUsers", ({ room, users }) => {
      outputRoomName(room);
      outputUsers(users);
    });

    // Message from server
    socket.on("message", (message) => {
      console.log(message);
      outputMessage(message);

      // Scroll down
      chatMessages.scrollTop = chatMessages.scrollHeight;
    });

    // Message submit
    chatForm.addEventListener("submit", (e) => {
      e.preventDefault();

      // Get message text
      const msg = e.target.elements.msg.value;

      // Emit message to server
      socket.emit("chatMessage", msg);

      // Clear input
      e.target.elements.msg.value = "";
      e.target.elements.msg.focus();
    });

    // Output message to DOM
    function outputMessage(message) {
      const div = document.createElement("div");
      div.classList.add("message");
      div.innerHTML = `<p class="meta">${message.username} <span>${message.time}</span></p>
    <p class="text">
      ${message.text}
    </p>`;
      document.querySelector(".chat-messages").appendChild(div);
    }

    // Add room name to DOM
    function outputRoomName(room) {
      roomName.innerText = room;
    }

    // Add users to DOM
    function outputUsers(users) {
      userList.innerHTML = `
      ${users.map((user) => `<li>${user.username}</li>`).join("")}
    `;
    }
  </script>
</html>
